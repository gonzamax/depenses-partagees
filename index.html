<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="D√©penses">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#667eea">
    <title>üí∞ D√©penses Partag√©es</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'%3E%3Crect width='192' height='192' rx='48' fill='%23667eea'/%3E%3Cpath d='M96 45c-28 0-51 23-51 51s23 51 51 51 51-23 51-51-23-51-51-51zm0 90c-21 0-39-18-39-39s18-39 39-39 39 18 39 39-18 39-39 39z' fill='%23fff'/%3E%3Cpath d='M96 67v58m-29-29h58' stroke='%23fff' stroke-width='9' stroke-linecap='round'/%3E%3C/svg%3E">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        /* ==========================================
           DESIGN SYSTEM - Variables CSS
           ========================================== */
        :root {
            /* Couleurs */
            --primary: #667eea;
            --primary-dark: #764ba2;
            --secondary: #f093fb;
            --success: #4CAF50;
            --danger: #F44336;
            --warning: #FF9800;
            --info: #2196F3;
            
            /* Neutres */
            --bg: #FAFAFA;
            --surface: #FFFFFF;
            --surface-variant: #F5F5F5;
            --border: #E0E0E0;
            --text: #212121;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            
            /* Espacements */
            --space-xxs: 4px;
            --space-xs: 8px;
            --space-s: 12px;
            --space-m: 16px;
            --space-l: 24px;
            --space-xl: 32px;
            --space-xxl: 48px;
            
            /* Border radius */
            --radius-s: 8px;
            --radius-m: 12px;
            --radius-l: 16px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            /* Ombres */
            --shadow-s: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-m: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-l: 0 8px 24px rgba(0, 0, 0, 0.16);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-base: 250ms ease;
            --transition-slow: 350ms ease;
            
            /* Z-index */
            --z-base: 1;
            --z-dropdown: 100;
            --z-sticky: 200;
            --z-modal: 1000;
            --z-toast: 2000;
        }
        
        /* ==========================================
           RESET & BASE
           ========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }
        
        /* Safe area iOS */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(0px, env(safe-area-inset-left));
                padding-right: max(0px, env(safe-area-inset-right));
                padding-top: max(0px, env(safe-area-inset-top));
                padding-bottom: max(0px, env(safe-area-inset-bottom));
            }
        }
        
        /* ==========================================
           LAYOUT PRINCIPAL
           ========================================== */
        .app-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: calc(70px + env(safe-area-inset-bottom));
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: var(--space-m);
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            box-shadow: var(--shadow-m);
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-s);
        }
        
        .header-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-s);
        }
        
        .header-status {
            display: flex;
            align-items: center;
            gap: var(--space-xs);
            font-size: 13px;
            padding: 4px var(--space-xs);
            background: rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-full);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
        }
        
        .status-dot.offline {
            background: #F44336;
        }
        
        .notification-btn {
            position: relative;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: var(--radius-m);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .notification-btn:active {
            transform: scale(0.95);
            background: rgba(255, 255, 255, 0.3);
        }
        
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: white;
            font-size: 11px;
            font-weight: 700;
            min-width: 18px;
            height: 18px;
            border-radius: var(--radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .app-content {
            flex: 1;
            padding: var(--space-m);
            padding-bottom: var(--space-xl);
        }
        
        /* ==========================================
           BOTTOM NAVIGATION
           ========================================== */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--surface);
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-around;
            padding: var(--space-xs) 0;
            padding-bottom: calc(var(--space-xs) + env(safe-area-inset-bottom));
            z-index: var(--z-sticky);
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: var(--space-xs);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
        }
        
        .nav-item.active {
            color: var(--primary);
        }
        
        .nav-item.active::before {
            content: '';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 3px;
            background: var(--primary);
            border-radius: 0 0 3px 3px;
        }
        
        .nav-icon {
            font-size: 24px;
        }
        
        .nav-label {
            font-size: 11px;
            font-weight: 600;
        }
        
        /* ==========================================
           CARTES & COMPOSANTS
           ========================================== */
        .card {
            background: var(--surface);
            border-radius: var(--radius-l);
            padding: var(--space-m);
            box-shadow: var(--shadow-s);
            margin-bottom: var(--space-m);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-m);
        }
        
        .card-title {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        
        .card-action {
            color: var(--primary);
            font-size: 14px;
            font-weight: 600;
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px var(--space-xs);
            border-radius: var(--radius-s);
            transition: var(--transition-fast);
        }
        
        .card-action:active {
            background: rgba(102, 126, 234, 0.1);
        }
        
        /* Carte m√©trique */
        .metric-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: var(--radius-l);
            padding: var(--space-l);
            box-shadow: var(--shadow-m);
        }
        
        .metric-label {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: var(--space-xs);
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: var(--space-xs);
        }
        
        .metric-detail {
            font-size: 13px;
            opacity: 0.85;
        }
        
        /* ==========================================
           FAB (Floating Action Button)
           ========================================== */
        .fab {
            position: fixed;
            bottom: calc(80px + env(safe-area-inset-bottom));
            right: var(--space-m);
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border: none;
            border-radius: 50%;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: var(--z-dropdown);
            transition: var(--transition-base);
        }
        
        .fab:active {
            transform: scale(0.95);
        }
        
        .fab svg {
            width: 24px;
            height: 24px;
            stroke: white;
            stroke-width: 2.5;
        }
        
        /* ==========================================
           BOTTOM SHEET
           ========================================== */
        .bottom-sheet-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            opacity: 0;
            transition: opacity var(--transition-base);
            pointer-events: none;
        }
        
        .bottom-sheet-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .bottom-sheet {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--surface);
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
            max-height: 90vh;
            transform: translateY(100%);
            transition: transform var(--transition-slow);
            z-index: calc(var(--z-modal) + 1);
            display: flex;
            flex-direction: column;
            box-shadow: 0 -4px 24px rgba(0, 0, 0, 0.15);
        }
        
        .bottom-sheet.active {
            transform: translateY(0);
        }
        
        .bottom-sheet-handle {
            width: 32px;
            height: 4px;
            background: var(--border);
            border-radius: 2px;
            margin: var(--space-s) auto var(--space-m);
            cursor: grab;
        }
        
        .bottom-sheet-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--space-l) var(--space-m);
            border-bottom: 1px solid var(--border);
        }
        
        .bottom-sheet-title {
            font-size: 18px;
            font-weight: 700;
        }
        
        .bottom-sheet-close {
            background: none;
            border: none;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .bottom-sheet-close:active {
            background: var(--surface-variant);
        }
        
        .bottom-sheet-content {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-l);
            -webkit-overflow-scrolling: touch;
        }
        
        .bottom-sheet-footer {
            padding: var(--space-m) var(--space-l);
            padding-bottom: calc(var(--space-m) + env(safe-area-inset-bottom));
            border-top: 1px solid var(--border);
        }
        
        /* ==========================================
           FORMULAIRES
           ========================================== */
        .form-group {
            margin-bottom: var(--space-m);
        }
        
        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: var(--space-xs);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            font-size: 16px;
            padding: var(--space-s) var(--space-m);
            border: 1px solid var(--border);
            border-radius: var(--radius-m);
            background: var(--surface);
            color: var(--text);
            transition: var(--transition-fast);
            font-family: inherit;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* ==========================================
           BOUTONS
           ========================================== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-xs);
            padding: var(--space-s) var(--space-l);
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: var(--radius-m);
            cursor: pointer;
            transition: var(--transition-fast);
            min-height: 44px;
            font-family: inherit;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            box-shadow: var(--shadow-s);
        }
        
        .btn-primary:active {
            transform: translateY(1px);
            box-shadow: none;
        }
        
        .btn-secondary {
            background: var(--surface-variant);
            color: var(--text);
        }
        
        .btn-secondary:active {
            background: var(--border);
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* ==========================================
           COMPOSANTS DASHBOARD
           ========================================== */
        
        /* Grille de cartes m√©triques */
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-s);
            margin-bottom: var(--space-m);
        }
        
        .metric-card-small {
            background: white;
            border-radius: var(--radius-l);
            padding: var(--space-m);
            box-shadow: var(--shadow-s);
        }
        
        .metric-card-small .label {
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: var(--space-xs);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .metric-card-small .value {
            font-size: 20px;
            font-weight: 700;
            color: var(--text);
        }
        
        .metric-card-small .percentage {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 2px;
        }
        
        /* Liste cat√©gories */
        .category-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-s);
        }
        
        .category-item {
            display: flex;
            align-items: center;
            gap: var(--space-s);
        }
        
        .category-icon {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-s);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: var(--surface-variant);
        }
        
        .category-info {
            flex: 1;
        }
        
        .category-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }
        
        .category-bar {
            height: 4px;
            background: var(--surface-variant);
            border-radius: 2px;
            margin-top: 4px;
            overflow: hidden;
        }
        
        .category-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--primary-dark));
            border-radius: 2px;
            transition: width var(--transition-base);
        }
        
        .category-amount {
            font-size: 14px;
            font-weight: 700;
            color: var(--text);
            white-space: nowrap;
        }
        
        /* Liste d√©penses r√©centes */
        .expense-list {
            display: flex;
            flex-direction: column;
            gap: var(--space-s);
        }
        
        .expense-item {
            background: white;
            border-radius: var(--radius-m);
            padding: var(--space-s);
            box-shadow: var(--shadow-s);
            display: flex;
            align-items: center;
            gap: var(--space-s);
            cursor: pointer;
            transition: var(--transition-fast);
        }
        
        .expense-item:active {
            transform: scale(0.98);
            box-shadow: none;
        }
        
        .expense-icon {
            width: 40px;
            height: 40px;
            border-radius: var(--radius-s);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            background: var(--surface-variant);
            flex-shrink: 0;
        }
        
        .expense-details {
            flex: 1;
            min-width: 0;
        }
        
        .expense-description {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .expense-meta {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .expense-amount {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
            flex-shrink: 0;
        }
        
        /* Mini graphique */
        .mini-chart {
            height: 120px;
            margin: var(--space-s) 0;
        }
        
        /* √âtat vide */
        .empty-state {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: var(--space-m);
            opacity: 0.5;
        }
        
        .empty-state-text {
            font-size: 14px;
        }
        
        /* Skeleton loader */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: var(--radius-s);
        }
        
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-text {
            height: 16px;
            margin-bottom: var(--space-xs);
        }
        
        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: var(--space-s);
        }
        
        /* Boutons d'action inline */
        .expense-item-actions {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-s);
        }
        
        .btn-icon {
            background: none;
            border: 1px solid var(--border);
            border-radius: var(--radius-s);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition-fast);
            font-size: 18px;
        }
        
        .btn-icon:active {
            transform: scale(0.95);
            background: var(--surface-variant);
        }
        
        .btn-icon.danger {
            border-color: var(--danger);
            color: var(--danger);
        }
        
        .btn-icon.danger:active {
            background: rgba(244, 67, 54, 0.1);
        }
        
        /* Tabs budget */
        .tab-button {
            background: none;
            border: none;
            padding: var(--space-s) var(--space-m);
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            cursor: pointer;
            position: relative;
            transition: var(--transition-fast);
        }
        
        .tab-button.active {
            color: var(--primary);
        }
        
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--primary);
        }
        
        .budget-tab-content {
            animation: fadeIn var(--transition-base);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Items r√©currentes/pr√©visionnelles */
        .recurrent-item {
            background: white;
            border-radius: var(--radius-m);
            padding: var(--space-s);
            box-shadow: var(--shadow-s);
            margin-bottom: var(--space-s);
        }
        
        .recurrent-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: var(--space-xs);
        }
        
        .recurrent-title {
            font-weight: 600;
            color: var(--text);
            font-size: 15px;
        }
        
        .recurrent-amount {
            font-weight: 700;
            color: var(--primary);
            font-size: 16px;
        }
        
        .recurrent-meta {
            font-size: 13px;
            color: var(--text-secondary);
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            margin-bottom: var(--space-xs);
        }
        
        .recurrent-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: var(--radius-s);
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-active {
            background: rgba(76, 175, 80, 0.1);
            color: var(--success);
        }
        
        .badge-inactive {
            background: rgba(158, 158, 158, 0.1);
            color: var(--text-tertiary);
        }
        
        .recurrent-actions {
            display: flex;
            gap: var(--space-xs);
            margin-top: var(--space-s);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
            min-height: 32px;
        }
        
        /* ==========================================
           UTILITAIRES
           ========================================== */
        .hidden {
            display: none !important;
        }
        
        .mt-s { margin-top: var(--space-s); }
        .mt-m { margin-top: var(--space-m); }
        .mt-l { margin-top: var(--space-l); }
        
        .mb-s { margin-bottom: var(--space-s); }
        .mb-m { margin-bottom: var(--space-m); }
        .mb-l { margin-bottom: var(--space-l); }
        
        .text-center { text-align: center; }
        .text-secondary { color: var(--text-secondary); }
        .text-small { font-size: 14px; }
        
        /* ==========================================
           √âCRAN D'ACCUEIL (Welcome Screen)
           ========================================== */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--space-xl);
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
        }
        
        .welcome-logo {
            font-size: 80px;
            margin-bottom: var(--space-l);
            animation: bounce 2s ease-in-out infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        
        .welcome-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: var(--space-m);
            text-align: center;
        }
        
        .welcome-subtitle {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: var(--space-xl);
            text-align: center;
        }
        
        .welcome-card {
            background: white;
            color: var(--text);
            border-radius: var(--radius-xl);
            padding: var(--space-xl);
            width: 100%;
            max-width: 400px;
            box-shadow: var(--shadow-l);
        }
        
        .welcome-card h3 {
            font-size: 20px;
            margin-bottom: var(--space-m);
            text-align: center;
        }
        
        /* ==========================================
           RESPONSIVE
           ========================================== */
        @media (max-width: 768px) {
            .app-content {
                padding: var(--space-s);
            }
            
            .card {
                padding: var(--space-s);
            }
            
            .metric-card {
                padding: var(--space-m);
            }
            
            .metric-value {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <!-- √âcran d'accueil (Welcome) -->
    <div id="welcome-screen" class="welcome-screen">
        <div class="welcome-logo">üí∞</div>
        <h1 class="welcome-title">D√©penses Partag√©es</h1>
        <p class="welcome-subtitle">G√©rez vos finances en famille</p>
        
        <div class="welcome-card">
            <h3>Commencer</h3>
            <div class="form-group">
                <label class="form-label">Cr√©er un nouvel espace</label>
                <button class="btn btn-primary btn-block" onclick="createNewRoom()">
                    ‚ú® Cr√©er un espace
                </button>
            </div>
            <div style="text-align: center; margin: var(--space-m) 0; color: var(--text-secondary);">ou</div>
            <div class="form-group">
                <label class="form-label">Rejoindre un espace existant</label>
                <input type="text" class="form-input" id="join-room-code" placeholder="Code d'appairage">
                <button class="btn btn-secondary btn-block mt-s" onclick="joinExistingRoom()">
                    üîó Rejoindre
                </button>
            </div>
        </div>
    </div>
    
    <!-- Application principale -->
    <div id="main-app" class="app-container hidden">
        <!-- Header -->
        <header class="app-header">
            <div class="header-top">
                <div class="header-title">
                    <span>üí∞</span>
                    <span>D√©penses</span>
                </div>
                <div class="header-actions">
                    <div class="header-status" id="sync-status">
                        <span class="status-dot" id="status-dot"></span>
                        <span id="status-text">Connect√©</span>
                    </div>
                    <button class="notification-btn" onclick="showNotifications()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-badge hidden" id="notification-badge">0</span>
                    </button>
                </div>
            </div>
        </header>
        
        <!-- Contenu principal -->
        <main class="app-content">
            <!-- Vue d'ensemble (Dashboard) -->
            <div id="view-dashboard" class="view">
                <h2 class="text-small text-secondary mb-m">üìä Vue d'ensemble</h2>
                
                <!-- Carte principale du mois -->
                <div class="metric-card mb-m">
                    <div class="metric-label">Ce mois-ci</div>
                    <div class="metric-value" id="dashboard-total">0,00 ‚Ç¨</div>
                    <div class="metric-detail" id="dashboard-detail">0 d√©pense</div>
                </div>
                
                <!-- Grille m√©triques -->
                <div class="metrics-grid">
                    <div class="metric-card-small">
                        <div class="label">
                            <span>üë§</span>
                            <span id="dashboard-parent1-name">Parent 1</span>
                        </div>
                        <div class="value" id="dashboard-parent1-amount">0,00 ‚Ç¨</div>
                        <div class="percentage" id="dashboard-parent1-percent">0%</div>
                    </div>
                    <div class="metric-card-small">
                        <div class="label">
                            <span>üë§</span>
                            <span id="dashboard-parent2-name">Parent 2</span>
                        </div>
                        <div class="value" id="dashboard-parent2-amount">0,00 ‚Ç¨</div>
                        <div class="percentage" id="dashboard-parent2-percent">0%</div>
                    </div>
                </div>
                
                <!-- √âvolution (mini graphique) -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìà √âvolution</h3>
                    </div>
                    <canvas id="mini-chart" class="mini-chart"></canvas>
                </div>
                
                <!-- Top cat√©gories -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè∑Ô∏è Top cat√©gories</h3>
                    </div>
                    <div class="category-list" id="top-categories">
                        <!-- Rempli dynamiquement -->
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-text">Aucune d√©pense ce mois</div>
                        </div>
                    </div>
                </div>
                
                <!-- D√©penses r√©centes -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìã R√©centes</h3>
                        <button class="card-action" onclick="switchView('stats')">Voir tout ‚Üí</button>
                    </div>
                    <div class="expense-list" id="recent-expenses">
                        <!-- Rempli dynamiquement -->
                        <div class="empty-state">
                            <div class="empty-state-icon">üí∞</div>
                            <div class="empty-state-text">Aucune d√©pense r√©cente</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Statistiques -->
            <div id="view-stats" class="view hidden">
                <h2 class="text-small text-secondary mb-m">üìä Statistiques d√©taill√©es</h2>
                
                <!-- Filtres -->
                <div class="card mb-m">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-s);">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Mois</label>
                            <select class="form-select" id="stats-month" onchange="updateStats()">
                                <option value="0">Janvier</option>
                                <option value="1">F√©vrier</option>
                                <option value="2">Mars</option>
                                <option value="3">Avril</option>
                                <option value="4">Mai</option>
                                <option value="5">Juin</option>
                                <option value="6">Juillet</option>
                                <option value="7">Ao√ªt</option>
                                <option value="8">Septembre</option>
                                <option value="9">Octobre</option>
                                <option value="10">Novembre</option>
                                <option value="11">D√©cembre</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label class="form-label">Ann√©e</label>
                            <select class="form-select" id="stats-year" onchange="updateStats()">
                                <!-- Rempli dynamiquement -->
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- R√©sum√© p√©riode -->
                <div class="metric-card mb-m">
                    <div class="metric-label" id="stats-period-label">Janvier 2026</div>
                    <div class="metric-value" id="stats-total">0,00 ‚Ç¨</div>
                    <div class="metric-detail" id="stats-count">0 d√©pense</div>
                </div>
                
                <!-- Graphique √©volution -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìà √âvolution</h3>
                    </div>
                    <canvas id="evolution-chart" style="height: 200px;"></canvas>
                </div>
                
                <!-- Graphique r√©partition cat√©gories -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üéØ Par cat√©gorie</h3>
                    </div>
                    <canvas id="category-chart" style="height: 200px;"></canvas>
                </div>
                
                <!-- R√©partition par personne -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üë• Par personne</h3>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: var(--space-m);">
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                <span style="font-weight: 600;" id="stats-parent1-name">Parent 1</span>
                                <span style="font-weight: 700;" id="stats-parent1-amount">0,00 ‚Ç¨</span>
                            </div>
                            <div class="category-bar">
                                <div class="category-bar-fill" id="stats-parent1-bar" style="width: 0%"></div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" id="stats-parent1-detail">0 d√©pense ‚Ä¢ 0%</div>
                        </div>
                        <div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                <span style="font-weight: 600;" id="stats-parent2-name">Parent 2</span>
                                <span style="font-weight: 700;" id="stats-parent2-amount">0,00 ‚Ç¨</span>
                            </div>
                            <div class="category-bar">
                                <div class="category-bar-fill" id="stats-parent2-bar" style="width: 0%"></div>
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;" id="stats-parent2-detail">0 d√©pense ‚Ä¢ 0%</div>
                        </div>
                    </div>
                </div>
                
                <!-- Filtres liste -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üìã Liste compl√®te</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-s); margin-bottom: var(--space-m);">
                        <div>
                            <select class="form-select" id="filter-category" onchange="updateStatsList()">
                                <option value="">Toutes cat√©gories</option>
                                <option value="Courses">üõí Courses</option>
                                <option value="Restaurant">üçΩÔ∏è Restaurant</option>
                                <option value="Transport">üöó Transport</option>
                                <option value="Loisirs">üéÆ Loisirs</option>
                                <option value="Sant√©">‚öïÔ∏è Sant√©</option>
                                <option value="Logement">üè† Logement</option>
                                <option value="Autre">üì¶ Autre</option>
                            </select>
                        </div>
                        <div>
                            <select class="form-select" id="filter-payeur" onchange="updateStatsList()">
                                <option value="">Tous payeurs</option>
                                <option value="Parent 1">Parent 1</option>
                                <option value="Parent 2">Parent 2</option>
                            </select>
                        </div>
                    </div>
                    <div class="expense-list" id="stats-expense-list">
                        <!-- Rempli dynamiquement -->
                    </div>
                </div>
            </div>
            
            <!-- Budget -->
            <div id="view-budget" class="view hidden">
                <h2 class="text-small text-secondary mb-m">üí∞ Budget & Pr√©visionnel</h2>
                
                <!-- R√©sum√© budget -->
                <div class="card mb-m">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-m);">
                        <div>
                            <div class="text-small text-secondary">Budget mensuel</div>
                            <div style="font-size: 24px; font-weight: 700; color: var(--text);" id="budget-total">0,00 ‚Ç¨</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="text-small text-secondary">R√©alis√© ce mois</div>
                            <div style="font-size: 24px; font-weight: 700;" id="budget-actual">0,00 ‚Ç¨</div>
                        </div>
                    </div>
                    <div class="category-bar" style="height: 8px;">
                        <div class="category-bar-fill" id="budget-progress-bar" style="width: 0%; background: var(--success);"></div>
                    </div>
                    <div class="text-small text-secondary mt-s" id="budget-status">Calcul√© √† partir des d√©penses r√©currentes</div>
                </div>
                
                <!-- Tabs -->
                <div style="display: flex; gap: var(--space-xs); margin-bottom: var(--space-m); border-bottom: 2px solid var(--border);">
                    <button class="tab-button active" data-budget-tab="recurrent" onclick="switchBudgetTab('recurrent')">
                        üîÑ R√©currentes
                    </button>
                    <button class="tab-button" data-budget-tab="previsionnel" onclick="switchBudgetTab('previsionnel')">
                        üìã Pr√©visionnelles
                    </button>
                    <button class="tab-button" data-budget-tab="objectifs" onclick="switchBudgetTab('objectifs')">
                        üíº Objectifs
                    </button>
                </div>
                
                <!-- Tab R√©currentes -->
                <div id="budget-tab-recurrent" class="budget-tab-content">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üîÑ D√©penses r√©currentes</h3>
                            <button class="card-action" onclick="showAddRecurrentSheet()">+ Ajouter</button>
                        </div>
                        <div id="recurrent-list" class="expense-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">üîÑ</div>
                                <div class="empty-state-text">Aucune d√©pense r√©currente</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Pr√©visionnelles -->
                <div id="budget-tab-previsionnel" class="budget-tab-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üìã D√©penses pr√©visionnelles</h3>
                            <button class="card-action" onclick="showAddPrevisionnelSheet()">+ Ajouter</button>
                        </div>
                        <div id="previsionnel-list" class="expense-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">üìã</div>
                                <div class="empty-state-text">Aucune d√©pense pr√©visionnelle</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Tab Objectifs -->
                <div id="budget-tab-objectifs" class="budget-tab-content hidden">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">üíº Objectifs d'√©pargne</h3>
                            <button class="card-action" onclick="showAddObjectifSheet()">+ Ajouter</button>
                        </div>
                        <div id="objectifs-list" class="expense-list">
                            <div class="empty-state">
                                <div class="empty-state-icon">üíº</div>
                                <div class="empty-state-text">Aucun objectif d√©fini</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Param√®tres -->
            <div id="view-settings" class="view hidden">
                <h2 class="text-small text-secondary mb-m">‚öôÔ∏è Param√®tres</h2>
                
                <!-- Code d'appairage -->
                <div class="card">
                    <h3 class="card-title mb-m">üîó Code d'appairage</h3>
                    <p class="text-small text-secondary mb-m">Partagez ce code avec votre famille pour synchroniser vos d√©penses</p>
                    <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%); padding: var(--space-m); border-radius: var(--radius-m); color: white;">
                        <div class="text-small" style="opacity: 0.9; margin-bottom: 4px;">Votre code :</div>
                        <div style="font-family: 'Courier New', monospace; font-size: 18px; font-weight: 700; letter-spacing: 2px; word-break: break-all; margin-bottom: var(--space-m);" id="settings-room-code">---</div>
                        <button class="btn btn-secondary btn-block" onclick="copyRoomCode()" style="background: white; color: var(--primary);">
                            üìã Copier le code
                        </button>
                    </div>
                </div>
                
                <!-- Profils -->
                <div class="card">
                    <h3 class="card-title mb-m">üë• Profils</h3>
                    <div class="form-group">
                        <label class="form-label">Parent 1</label>
                        <input type="text" class="form-input" id="settings-parent1-name" placeholder="Nom" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Parent 1</label>
                        <input type="email" class="form-input" id="settings-parent1-email" placeholder="email@example.com" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Parent 2</label>
                        <input type="text" class="form-input" id="settings-parent2-name" placeholder="Nom" onchange="saveSettings()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email Parent 2</label>
                        <input type="email" class="form-input" id="settings-parent2-email" placeholder="email@example.com" onchange="saveSettings()">
                    </div>
                </div>
                
                <!-- Notifications -->
                <div class="card">
                    <h3 class="card-title mb-m">üîî Notifications</h3>
                    <div style="background: var(--surface-variant); padding: var(--space-m); border-radius: var(--radius-m); margin-bottom: var(--space-m);">
                        <div style="display: flex; align-items: center; gap: var(--space-m);">
                            <div style="background: white; width: 48px; height: 48px; border-radius: var(--radius-m); display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-s);">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#667eea" stroke-width="2">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                                </svg>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 2px;">Badge dans l'application</div>
                                <div class="text-small text-secondary">Toujours actif</div>
                            </div>
                            <div class="recurrent-badge badge-active">‚úì ACTIF</div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">üìß Email quotidien/hebdomadaire</label>
                        <select class="form-select" id="settings-email-frequency" onchange="saveSettings()">
                            <option value="none">D√©sactiv√©</option>
                            <option value="daily">Quotidien</option>
                            <option value="weekly">Hebdomadaire</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="settings-email-time-group">
                        <label class="form-label">‚è∞ Heure d'envoi</label>
                        <select class="form-select" id="settings-email-time" onchange="saveSettings()">
                            <option value="08:00">08:00</option>
                            <option value="12:00">12:00</option>
                            <option value="18:00" selected>18:00</option>
                            <option value="20:00">20:00</option>
                        </select>
                    </div>
                    
                    <button class="btn btn-secondary btn-block" onclick="sendTestEmail()">
                        üì® Envoyer un email de test
                    </button>
                </div>
                
                <!-- Cat√©gories personnalis√©es -->
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">üè∑Ô∏è Cat√©gories</h3>
                        <button class="card-action" onclick="addCategory()">+ Ajouter</button>
                    </div>
                    <div id="categories-list">
                        <div class="text-small text-secondary">Cat√©gories par d√©faut</div>
                    </div>
                </div>
                
                <!-- Sauvegarde -->
                <div class="card">
                    <h3 class="card-title mb-m">üíæ Sauvegarde</h3>
                    <div style="display: grid; gap: var(--space-s);">
                        <button class="btn btn-secondary btn-block" onclick="exportData()">
                            üì• Exporter toutes les donn√©es (JSON)
                        </button>
                        <button class="btn btn-secondary btn-block" onclick="importData()">
                            üì§ Importer des donn√©es
                        </button>
                        <input type="file" id="import-file-input" accept=".json" style="display: none;" onchange="handleImportFile(event)">
                    </div>
                </div>
                
                <!-- √Ä propos -->
                <div class="card">
                    <h3 class="card-title mb-m">‚ÑπÔ∏è √Ä propos</h3>
                    <div style="text-align: center; color: var(--text-secondary);">
                        <div style="font-size: 48px; margin-bottom: var(--space-m);">üí∞</div>
                        <div style="font-weight: 700; font-size: 18px; color: var(--text); margin-bottom: 4px;">D√©penses Partag√©es</div>
                        <div class="text-small" style="margin-bottom: var(--space-m);">Version 2.0</div>
                        <div class="text-small">Refonte moderne ‚Ä¢ Design optimis√© ‚Ä¢ Synchronisation temps r√©el</div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- FAB -->
        <button class="fab" onclick="showAddExpenseSheet()">
            <svg viewBox="0 0 24 24" fill="none">
                <path d="M12 5v14M5 12h14" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
        </button>
        
        <!-- Bottom Navigation -->
        <nav class="bottom-nav">
            <button class="nav-item active" onclick="switchView('dashboard')" data-view="dashboard">
                <span class="nav-icon">üè†</span>
                <span class="nav-label">Accueil</span>
            </button>
            <button class="nav-item" onclick="switchView('stats')" data-view="stats">
                <span class="nav-icon">üìä</span>
                <span class="nav-label">Stats</span>
            </button>
            <button class="nav-item" onclick="switchView('budget')" data-view="budget">
                <span class="nav-icon">üí∞</span>
                <span class="nav-label">Budget</span>
            </button>
            <button class="nav-item" onclick="switchView('settings')" data-view="settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-label">Param√®tres</span>
            </button>
        </nav>
    </div>
    
    <!-- Bottom Sheet - Ajouter d√©pense -->
    <div class="bottom-sheet-overlay" id="add-expense-overlay" onclick="closeAddExpenseSheet()"></div>
    <div class="bottom-sheet" id="add-expense-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h2 class="bottom-sheet-title">‚ú® Nouvelle d√©pense</h2>
            <button class="bottom-sheet-close" onclick="closeAddExpenseSheet()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="bottom-sheet-content">
            <form id="expense-form" onsubmit="addExpense(event)">
                <div class="form-group">
                    <label class="form-label">üí∞ Montant</label>
                    <input type="number" step="0.01" class="form-input" id="expense-amount" placeholder="0,00" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìù Description</label>
                    <input type="text" class="form-input" id="expense-description" placeholder="Ex: Courses Carrefour" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìÇ Cat√©gorie</label>
                    <select class="form-select" id="expense-category">
                        <option value="Courses">üõí Courses</option>
                        <option value="Restaurant">üçΩÔ∏è Restaurant</option>
                        <option value="Transport">üöó Transport</option>
                        <option value="Loisirs">üéÆ Loisirs</option>
                        <option value="Sant√©">‚öïÔ∏è Sant√©</option>
                        <option value="Logement">üè† Logement</option>
                        <option value="Autre">üì¶ Autre</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üë§ Pay√© par</label>
                    <select class="form-select" id="expense-payeur">
                        <option value="Parent 1">Parent 1</option>
                        <option value="Parent 2">Parent 2</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìÖ Date</label>
                    <input type="date" class="form-input" id="expense-date" required>
                </div>
            </form>
        </div>
        <div class="bottom-sheet-footer">
            <button type="submit" form="expense-form" class="btn btn-primary btn-block">
                ‚úì Enregistrer
            </button>
        </div>
    </div>
    
    <!-- Bottom Sheet - Ajouter r√©currente -->
    <div class="bottom-sheet-overlay" id="add-recurrent-overlay" onclick="closeAddRecurrentSheet()"></div>
    <div class="bottom-sheet" id="add-recurrent-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h2 class="bottom-sheet-title">üîÑ D√©pense r√©currente</h2>
            <button class="bottom-sheet-close" onclick="closeAddRecurrentSheet()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="bottom-sheet-content">
            <form id="recurrent-form" onsubmit="addRecurrent(event)">
                <div class="form-group">
                    <label class="form-label">üìù Description</label>
                    <input type="text" class="form-input" id="recurrent-description" placeholder="Ex: Loyer" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üí∞ Montant</label>
                    <input type="number" step="0.01" class="form-input" id="recurrent-amount" placeholder="0,00" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üîÑ Fr√©quence</label>
                    <select class="form-select" id="recurrent-frequency" onchange="updateRecurrentFields()">
                        <option value="daily">Quotidien</option>
                        <option value="weekly">Hebdomadaire</option>
                        <option value="monthly" selected>Mensuel</option>
                        <option value="yearly">Annuel</option>
                    </select>
                </div>
                
                <div class="form-group hidden" id="recurrent-day-of-week-group">
                    <label class="form-label">üìÜ Jour de la semaine</label>
                    <select class="form-select" id="recurrent-day-of-week">
                        <option value="1">Lundi</option>
                        <option value="2">Mardi</option>
                        <option value="3">Mercredi</option>
                        <option value="4">Jeudi</option>
                        <option value="5">Vendredi</option>
                        <option value="6">Samedi</option>
                        <option value="0">Dimanche</option>
                    </select>
                </div>
                
                <div class="form-group hidden" id="recurrent-day-of-month-group">
                    <label class="form-label">üìÖ Jour du mois</label>
                    <input type="number" min="1" max="31" class="form-input" id="recurrent-day-of-month" value="1">
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìÇ Cat√©gorie</label>
                    <select class="form-select" id="recurrent-category">
                        <option value="Courses">üõí Courses</option>
                        <option value="Restaurant">üçΩÔ∏è Restaurant</option>
                        <option value="Transport">üöó Transport</option>
                        <option value="Loisirs">üéÆ Loisirs</option>
                        <option value="Sant√©">‚öïÔ∏è Sant√©</option>
                        <option value="Logement" selected>üè† Logement</option>
                        <option value="Autre">üì¶ Autre</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üë§ Pay√© par</label>
                    <select class="form-select" id="recurrent-payeur">
                        <option value="Parent 1">Parent 1</option>
                        <option value="Parent 2">Parent 2</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üóìÔ∏è Date de d√©but</label>
                    <input type="date" class="form-input" id="recurrent-start-date" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        <input type="checkbox" id="recurrent-active" checked style="width: auto; margin-right: 8px;">
                        ‚úì Active
                    </label>
                </div>
            </form>
        </div>
        <div class="bottom-sheet-footer">
            <button type="submit" form="recurrent-form" class="btn btn-primary btn-block">
                ‚úì Enregistrer
            </button>
        </div>
    </div>
    
    <!-- Bottom Sheet - Ajouter pr√©visionnelle -->
    <div class="bottom-sheet-overlay" id="add-previsionnel-overlay" onclick="closeAddPrevisionnelSheet()"></div>
    <div class="bottom-sheet" id="add-previsionnel-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h2 class="bottom-sheet-title">üìã D√©pense pr√©visionnelle</h2>
            <button class="bottom-sheet-close" onclick="closeAddPrevisionnelSheet()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="bottom-sheet-content">
            <form id="previsionnel-form" onsubmit="addPrevisionnel(event)">
                <div class="form-group">
                    <label class="form-label">üìù Description</label>
                    <input type="text" class="form-input" id="previsionnel-description" placeholder="Ex: R√©paration voiture" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üí∞ Montant</label>
                    <input type="number" step="0.01" class="form-input" id="previsionnel-amount" placeholder="0,00" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìÖ Date pr√©vue</label>
                    <input type="date" class="form-input" id="previsionnel-date" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìÇ Cat√©gorie</label>
                    <select class="form-select" id="previsionnel-category">
                        <option value="Courses">üõí Courses</option>
                        <option value="Restaurant">üçΩÔ∏è Restaurant</option>
                        <option value="Transport">üöó Transport</option>
                        <option value="Loisirs">üéÆ Loisirs</option>
                        <option value="Sant√©">‚öïÔ∏è Sant√©</option>
                        <option value="Logement">üè† Logement</option>
                        <option value="Autre">üì¶ Autre</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üë§ Pay√© par</label>
                    <select class="form-select" id="previsionnel-payeur">
                        <option value="Parent 1">Parent 1</option>
                        <option value="Parent 2">Parent 2</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="bottom-sheet-footer">
            <button type="submit" form="previsionnel-form" class="btn btn-primary btn-block">
                ‚úì Enregistrer
            </button>
        </div>
    </div>
    
    <!-- Bottom Sheet - Ajouter objectif -->
    <div class="bottom-sheet-overlay" id="add-objectif-overlay" onclick="closeAddObjectifSheet()"></div>
    <div class="bottom-sheet" id="add-objectif-sheet">
        <div class="bottom-sheet-handle"></div>
        <div class="bottom-sheet-header">
            <h2 class="bottom-sheet-title">üíº Objectif d'√©pargne</h2>
            <button class="bottom-sheet-close" onclick="closeAddObjectifSheet()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="bottom-sheet-content">
            <form id="objectif-form" onsubmit="addObjectif(event)">
                <div class="form-group">
                    <label class="form-label">üìù Description</label>
                    <input type="text" class="form-input" id="objectif-description" placeholder="Ex: Vacances √©t√©" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üí∞ Montant mensuel</label>
                    <input type="number" step="0.01" class="form-input" id="objectif-amount" placeholder="0,00" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">üìÇ Cat√©gorie</label>
                    <select class="form-select" id="objectif-category">
                        <option value="√âpargne">üí∞ √âpargne</option>
                        <option value="Vacances">‚úàÔ∏è Vacances</option>
                        <option value="Projet">üéØ Projet</option>
                        <option value="Autre">üì¶ Autre</option>
                    </select>
                </div>
            </form>
        </div>
        <div class="bottom-sheet-footer">
            <button type="submit" form="objectif-form" class="btn btn-primary btn-block">
                ‚úì Enregistrer
            </button>
        </div>
    </div>
    
    <script>
        // ==========================================
        // VARIABLES GLOBALES
        // ==========================================
        let currentRoomId = null;
        let supabase = null;
        let expenses = [];
        let recurrentExpenses = [];
        let budgetItems = []; // Pr√©visionnelles + Objectifs
        let settings = {
            parent1_name: 'Parent 1',
            parent2_name: 'Parent 2',
            currency_symbol: '‚Ç¨'
        };
        
        // ==========================================
        // INITIALISATION
        // ==========================================
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Application d√©marr√©e');
            
            // Charger Supabase
            await loadSupabase();
            
            // V√©rifier si un room existe d√©j√†
            const savedRoomId = localStorage.getItem('currentRoomId');
            if (savedRoomId) {
                currentRoomId = savedRoomId;
                await showMainApp();
            }
            
            // Date par d√©faut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
        });
        
        // ==========================================
        // SUPABASE
        // ==========================================
        async function loadSupabase() {
            try {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                document.head.appendChild(script);
                
                await new Promise((resolve, reject) => {
                    script.onload = resolve;
                    script.onerror = reject;
                });
                
                const SUPABASE_URL = 'https://dxrcljvocqtmgqujriul.supabase.co';
                const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR4cmNsanZvY3F0bWdxdWpyaXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1MTYzNjUsImV4cCI6MjA1MjA5MjM2NX0.BYiQkKQ7Y3_0h3z92kQCmLo6fNOVJ7aO5KcH2o9tsDY';
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úÖ Supabase charg√©');
            } catch (error) {
                console.error('‚ùå Erreur Supabase:', error);
            }
        }
        
        // ==========================================
        // NAVIGATION
        // ==========================================
        function switchView(viewName) {
            // Cacher toutes les vues
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            
            // Afficher la vue demand√©e
            document.getElementById(`view-${viewName}`).classList.remove('hidden');
            
            // Mettre √† jour la nav
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            
            // Initialiser les vues au besoin
            if (viewName === 'stats') {
                initStatsView();
            } else if (viewName === 'budget') {
                loadBudgetData();
            }
        }
        
        // ==========================================
        // BOTTOM SHEET
        // ==========================================
        function showAddExpenseSheet() {
            document.getElementById('add-expense-overlay').classList.add('active');
            document.getElementById('add-expense-sheet').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeAddExpenseSheet() {
            document.getElementById('add-expense-overlay').classList.remove('active');
            document.getElementById('add-expense-sheet').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        // ==========================================
        // ROOMS
        // ==========================================
        async function createNewRoom() {
            const randomId = 'room-' + Math.random().toString(36).substring(2, 15);
            currentRoomId = randomId;
            localStorage.setItem('currentRoomId', randomId);
            
            // Cr√©er la room dans Supabase
            if (supabase) {
                await supabase.from('rooms').insert({ room_id: randomId });
            }
            
            await showMainApp();
        }
        
        async function joinExistingRoom() {
            const code = document.getElementById('join-room-code').value.trim();
            if (!code) {
                alert('Veuillez entrer un code');
                return;
            }
            
            currentRoomId = code;
            localStorage.setItem('currentRoomId', code);
            await showMainApp();
        }
        
        async function showMainApp() {
            document.getElementById('welcome-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
            
            // Charger les donn√©es
            await loadData();
        }
        
        // ==========================================
        // DONN√âES
        // ==========================================
        async function loadData() {
            if (!supabase || !currentRoomId) return;
            
            // Charger les d√©penses
            const { data } = await supabase
                .from('expenses')
                .select('*')
                .eq('room_id', currentRoomId)
                .order('created_at', { ascending: false });
            
            expenses = data || [];
            
            // Charger aussi les donn√©es budget
            await loadBudgetData();
            
            updateDashboard();
        }
        
        function updateDashboard() {
            // Calculer le total du mois en cours
            const now = new Date();
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();
            
            const monthExpenses = expenses.filter(e => {
                const expDate = new Date(e.date);
                return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
            });
            
            const total = monthExpenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
            
            // Carte principale
            document.getElementById('dashboard-total').textContent = 
                total.toFixed(2) + ' ' + settings.currency_symbol;
            
            document.getElementById('dashboard-detail').textContent = 
                `${monthExpenses.length} d√©pense${monthExpenses.length > 1 ? 's' : ''}`;
            
            // R√©partition par payeur
            const parent1Expenses = monthExpenses.filter(e => e.payeur === settings.parent1_name || e.payeur === 'Parent 1');
            const parent2Expenses = monthExpenses.filter(e => e.payeur === settings.parent2_name || e.payeur === 'Parent 2');
            
            const parent1Total = parent1Expenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
            const parent2Total = parent2Expenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
            
            const parent1Percent = total > 0 ? (parent1Total / total * 100).toFixed(0) : 0;
            const parent2Percent = total > 0 ? (parent2Total / total * 100).toFixed(0) : 0;
            
            document.getElementById('dashboard-parent1-name').textContent = settings.parent1_name || 'Parent 1';
            document.getElementById('dashboard-parent1-amount').textContent = parent1Total.toFixed(2) + ' ' + settings.currency_symbol;
            document.getElementById('dashboard-parent1-percent').textContent = parent1Percent + '%';
            
            document.getElementById('dashboard-parent2-name').textContent = settings.parent2_name || 'Parent 2';
            document.getElementById('dashboard-parent2-amount').textContent = parent2Total.toFixed(2) + ' ' + settings.currency_symbol;
            document.getElementById('dashboard-parent2-percent').textContent = parent2Percent + '%';
            
            // Top cat√©gories
            updateTopCategories(monthExpenses);
            
            // D√©penses r√©centes
            updateRecentExpenses();
            
            // Mini graphique
            updateMiniChart();
        }
        
        function updateTopCategories(monthExpenses) {
            const categoriesMap = {};
            
            monthExpenses.forEach(e => {
                const cat = e.categorie || 'Autre';
                if (!categoriesMap[cat]) {
                    categoriesMap[cat] = 0;
                }
                categoriesMap[cat] += parseFloat(e.montant || 0);
            });
            
            const categories = Object.entries(categoriesMap)
                .map(([name, amount]) => ({ name, amount }))
                .sort((a, b) => b.amount - a.amount)
                .slice(0, 3);
            
            const container = document.getElementById('top-categories');
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìä</div>
                        <div class="empty-state-text">Aucune d√©pense ce mois</div>
                    </div>
                `;
                return;
            }
            
            const total = monthExpenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
            const categoryIcons = {
                'Courses': 'üõí',
                'Restaurant': 'üçΩÔ∏è',
                'Transport': 'üöó',
                'Loisirs': 'üéÆ',
                'Sant√©': '‚öïÔ∏è',
                'Logement': 'üè†',
                'Autre': 'üì¶'
            };
            
            container.innerHTML = categories.map(cat => {
                const percent = ((cat.amount / total) * 100).toFixed(0);
                const icon = categoryIcons[cat.name] || 'üì¶';
                
                return `
                    <div class="category-item">
                        <div class="category-icon">${icon}</div>
                        <div class="category-info">
                            <div class="category-name">${cat.name}</div>
                            <div class="category-bar">
                                <div class="category-bar-fill" style="width: ${percent}%"></div>
                            </div>
                        </div>
                        <div class="category-amount">${cat.amount.toFixed(2)} ${settings.currency_symbol}</div>
                    </div>
                `;
            }).join('');
        }
        
        function updateRecentExpenses() {
            const recent = expenses.slice(0, 5);
            const container = document.getElementById('recent-expenses');
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <div class="empty-state-text">Aucune d√©pense r√©cente</div>
                    </div>
                `;
                return;
            }
            
            const categoryIcons = {
                'Courses': 'üõí',
                'Restaurant': 'üçΩÔ∏è',
                'Transport': 'üöó',
                'Loisirs': 'üéÆ',
                'Sant√©': '‚öïÔ∏è',
                'Logement': 'üè†',
                'Autre': 'üì¶'
            };
            
            container.innerHTML = recent.map(exp => {
                const icon = categoryIcons[exp.categorie] || 'üí∞';
                const date = new Date(exp.date);
                const dateStr = formatDate(date);
                
                return `
                    <div class="expense-item" onclick="editExpense('${exp.id}')">
                        <div class="expense-icon">${icon}</div>
                        <div class="expense-details">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-meta">${dateStr} ‚Ä¢ ${exp.payeur || 'Non sp√©cifi√©'}</div>
                        </div>
                        <div class="expense-amount">${parseFloat(exp.montant).toFixed(2)} ${settings.currency_symbol}</div>
                    </div>
                `;
            }).join('');
        }
        
        function formatDate(date) {
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return "Aujourd'hui";
            if (days === 1) return "Hier";
            if (days < 7) return `Il y a ${days} jours`;
            
            const months = ['jan', 'f√©v', 'mar', 'avr', 'mai', 'juin', 'juil', 'ao√ªt', 'sep', 'oct', 'nov', 'd√©c'];
            return `${date.getDate()} ${months[date.getMonth()]}`;
        }
        
        function updateMiniChart() {
            const canvas = document.getElementById('mini-chart');
            if (!canvas) return;
            
            // D√©truire le graphique existant
            if (window.miniChartInstance) {
                window.miniChartInstance.destroy();
            }
            
            // Calculer les 7 derniers jours
            const days = [];
            const amounts = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                days.push(date.toLocaleDateString('fr-FR', { weekday: 'short' }));
                
                const dayExpenses = expenses.filter(e => {
                    const expDate = new Date(e.date);
                    return expDate.toDateString() === date.toDateString();
                });
                
                const total = dayExpenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
                amounts.push(total);
            }
            
            const ctx = canvas.getContext('2d');
            window.miniChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: days,
                    datasets: [{
                        label: 'D√©penses',
                        data: amounts,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 3,
                        pointBackgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' ‚Ç¨';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function editExpense(id) {
            // TODO: Impl√©menter l'√©dition
            alert('√âdition √† impl√©menter - ID: ' + id);
        }
        
        // ==========================================
        // STATISTIQUES
        // ==========================================
        let evolutionChartInstance = null;
        let categoryChartInstance = null;
        
        function initStatsView() {
            // Initialiser les s√©lecteurs de date
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Remplir le s√©lecteur d'ann√©e
            const yearSelect = document.getElementById('stats-year');
            yearSelect.innerHTML = '';
            for (let year = currentYear - 2; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }
            
            // S√©lectionner le mois actuel
            document.getElementById('stats-month').value = currentMonth;
            
            // Mettre √† jour les stats
            updateStats();
        }
        
        function updateStats() {
            const month = parseInt(document.getElementById('stats-month').value);
            const year = parseInt(document.getElementById('stats-year').value);
            
            // Filtrer les d√©penses du mois
            const monthExpenses = expenses.filter(e => {
                const expDate = new Date(e.date);
                return expDate.getMonth() === month && expDate.getFullYear() === year;
            });
            
            // Mettre √† jour le r√©sum√©
            const total = monthExpenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
            const monthNames = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
            
            document.getElementById('stats-period-label').textContent = `${monthNames[month]} ${year}`;
            document.getElementById('stats-total').textContent = total.toFixed(2) + ' ' + settings.currency_symbol;
            document.getElementById('stats-count').textContent = `${monthExpenses.length} d√©pense${monthExpenses.length > 1 ? 's' : ''}`;
            
            // R√©partition par personne
            updateStatsPersons(monthExpenses);
            
            // Graphiques
            updateEvolutionChart(month, year, monthExpenses);
            updateCategoryChart(monthExpenses);
            
            // Liste
            updateStatsList();
        }
        
        function updateStatsPersons(monthExpenses) {
            const parent1Expenses = monthExpenses.filter(e => e.payeur === settings.parent1_name || e.payeur === 'Parent 1');
            const parent2Expenses = monthExpenses.filter(e => e.payeur === settings.parent2_name || e.payeur === 'Parent 2');
            
            const parent1Total = parent1Expenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
            const parent2Total = parent2Expenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
            
            const total = parent1Total + parent2Total;
            const parent1Percent = total > 0 ? (parent1Total / total * 100).toFixed(0) : 0;
            const parent2Percent = total > 0 ? (parent2Total / total * 100).toFixed(0) : 0;
            
            document.getElementById('stats-parent1-name').textContent = settings.parent1_name || 'Parent 1';
            document.getElementById('stats-parent1-amount').textContent = parent1Total.toFixed(2) + ' ' + settings.currency_symbol;
            document.getElementById('stats-parent1-bar').style.width = parent1Percent + '%';
            document.getElementById('stats-parent1-detail').textContent = `${parent1Expenses.length} d√©pense${parent1Expenses.length > 1 ? 's' : ''} ‚Ä¢ ${parent1Percent}%`;
            
            document.getElementById('stats-parent2-name').textContent = settings.parent2_name || 'Parent 2';
            document.getElementById('stats-parent2-amount').textContent = parent2Total.toFixed(2) + ' ' + settings.currency_symbol;
            document.getElementById('stats-parent2-bar').style.width = parent2Percent + '%';
            document.getElementById('stats-parent2-detail').textContent = `${parent2Expenses.length} d√©pense${parent2Expenses.length > 1 ? 's' : ''} ‚Ä¢ ${parent2Percent}%`;
        }
        
        function updateEvolutionChart(month, year, monthExpenses) {
            const canvas = document.getElementById('evolution-chart');
            if (!canvas) return;
            
            if (evolutionChartInstance) {
                evolutionChartInstance.destroy();
            }
            
            // Calculer les jours du mois
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const labels = [];
            const data = [];
            
            for (let day = 1; day <= daysInMonth; day++) {
                labels.push(day);
                
                const dayExpenses = monthExpenses.filter(e => {
                    const expDate = new Date(e.date);
                    return expDate.getDate() === day;
                });
                
                const dayTotal = dayExpenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
                data.push(dayTotal);
            }
            
            const ctx = canvas.getContext('2d');
            evolutionChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'D√©penses',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 2,
                        pointBackgroundColor: '#667eea'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' ‚Ç¨';
                                }
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 10
                            }
                        }
                    }
                }
            });
        }
        
        function updateCategoryChart(monthExpenses) {
            const canvas = document.getElementById('category-chart');
            if (!canvas) return;
            
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
            }
            
            // Calculer les totaux par cat√©gorie
            const categoriesMap = {};
            monthExpenses.forEach(e => {
                const cat = e.categorie || 'Autre';
                if (!categoriesMap[cat]) {
                    categoriesMap[cat] = 0;
                }
                categoriesMap[cat] += parseFloat(e.montant || 0);
            });
            
            const categories = Object.entries(categoriesMap)
                .map(([name, amount]) => ({ name, amount }))
                .sort((a, b) => b.amount - a.amount);
            
            if (categories.length === 0) {
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif';
                ctx.fillStyle = '#999';
                ctx.textAlign = 'center';
                ctx.fillText('Aucune donn√©e', canvas.width / 2, canvas.height / 2);
                return;
            }
            
            const colors = [
                '#667eea',
                '#764ba2',
                '#f093fb',
                '#4facfe',
                '#43e97b',
                '#fa709a',
                '#fee140'
            ];
            
            const ctx = canvas.getContext('2d');
            categoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories.map(c => c.name),
                    datasets: [{
                        data: categories.map(c => c.amount),
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
        
        function updateStatsList() {
            const month = parseInt(document.getElementById('stats-month').value);
            const year = parseInt(document.getElementById('stats-year').value);
            const filterCategory = document.getElementById('filter-category').value;
            const filterPayeur = document.getElementById('filter-payeur').value;
            
            // Filtrer les d√©penses
            let filteredExpenses = expenses.filter(e => {
                const expDate = new Date(e.date);
                return expDate.getMonth() === month && expDate.getFullYear() === year;
            });
            
            if (filterCategory) {
                filteredExpenses = filteredExpenses.filter(e => e.categorie === filterCategory);
            }
            
            if (filterPayeur) {
                filteredExpenses = filteredExpenses.filter(e => e.payeur === filterPayeur);
            }
            
            const container = document.getElementById('stats-expense-list');
            
            if (filteredExpenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">Aucune d√©pense trouv√©e</div>
                    </div>
                `;
                return;
            }
            
            const categoryIcons = {
                'Courses': 'üõí',
                'Restaurant': 'üçΩÔ∏è',
                'Transport': 'üöó',
                'Loisirs': 'üéÆ',
                'Sant√©': '‚öïÔ∏è',
                'Logement': 'üè†',
                'Autre': 'üì¶'
            };
            
            container.innerHTML = filteredExpenses.map(exp => {
                const icon = categoryIcons[exp.categorie] || 'üí∞';
                const date = new Date(exp.date);
                const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'short' });
                
                return `
                    <div class="expense-item" onclick="showExpenseActions('${exp.id}')">
                        <div class="expense-icon">${icon}</div>
                        <div class="expense-details">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-meta">${dateStr} ‚Ä¢ ${exp.payeur || 'Non sp√©cifi√©'}</div>
                        </div>
                        <div class="expense-amount">${parseFloat(exp.montant).toFixed(2)} ${settings.currency_symbol}</div>
                    </div>
                `;
            }).join('');
        }
        
        function showExpenseActions(id) {
            const expense = expenses.find(e => e.id === id);
            if (!expense) return;
            
            const actions = confirm(`${expense.description}\n${expense.montant} ${settings.currency_symbol}\n\nQue voulez-vous faire ?\n\nOK = Modifier\nAnnuler = Supprimer`);
            
            if (actions) {
                editExpenseById(id);
            } else {
                if (confirm('Confirmer la suppression ?')) {
                    deleteExpense(id);
                }
            }
        }
        
        function editExpenseById(id) {
            alert('√âdition √† impl√©menter - ID: ' + id);
        }
        
        async function deleteExpense(id) {
            if (!supabase) return;
            
            await supabase.from('expenses').delete().eq('id', id);
            await loadData();
            updateStats();
        }
        
        // ==========================================
        // AJOUTER D√âPENSE
        // ==========================================
        async function addExpense(event) {
            event.preventDefault();
            
            const expense = {
                room_id: currentRoomId,
                montant: parseFloat(document.getElementById('expense-amount').value),
                description: document.getElementById('expense-description').value,
                categorie: document.getElementById('expense-category').value,
                payeur: document.getElementById('expense-payeur').value,
                date: document.getElementById('expense-date').value,
                created_at: new Date().toISOString()
            };
            
            if (supabase) {
                await supabase.from('expenses').insert(expense);
            }
            
            // R√©initialiser le formulaire
            document.getElementById('expense-form').reset();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('expense-date').value = today;
            
            // Fermer le sheet
            closeAddExpenseSheet();
            
            // Recharger les donn√©es
            await loadData();
        }
        
        // ==========================================
        // NOTIFICATIONS (placeholder)
        // ==========================================
        function showNotifications() {
            alert('Notifications - En d√©veloppement');
        }
        
        // ==========================================
        // BUDGET & R√âCURRENTES
        // ==========================================
        
        // Tabs budget
        function switchBudgetTab(tabName) {
            // Cacher tous les tabs
            document.querySelectorAll('.budget-tab-content').forEach(t => t.classList.add('hidden'));
            document.querySelectorAll('.tab-button').forEach(t => t.classList.remove('active'));
            
            // Afficher le tab demand√©
            document.getElementById(`budget-tab-${tabName}`).classList.remove('hidden');
            document.querySelector(`[data-budget-tab="${tabName}"]`).classList.add('active');
        }
        
        // Charger les donn√©es budget
        async function loadBudgetData() {
            if (!supabase || !currentRoomId) return;
            
            // Charger r√©currentes
            const { data: recData } = await supabase
                .from('recurrent_expenses')
                .select('*')
                .eq('room_id', currentRoomId)
                .order('created_at', { ascending: false });
            
            recurrentExpenses = recData || [];
            
            // Charger budget items (pr√©visionnelles + objectifs) depuis rooms.budget_items
            const { data: roomData } = await supabase
                .from('rooms')
                .select('budget_items')
                .eq('room_id', currentRoomId)
                .single();
            
            budgetItems = (roomData && roomData.budget_items) || [];
            
            updateBudgetSummary();
            updateRecurrentList();
            updatePrevisionnelList();
            updateObjectifsList();
        }
        
        // R√©sum√© budget
        function updateBudgetSummary() {
            // Calculer budget mensuel (somme des r√©currentes actives mensuelles)
            const monthlyBudget = recurrentExpenses
                .filter(r => r.active && r.frequency === 'monthly')
                .reduce((sum, r) => sum + parseFloat(r.montant || 0), 0);
            
            // Calculer r√©el du mois
            const now = new Date();
            const monthExpenses = expenses.filter(e => {
                const expDate = new Date(e.date);
                return expDate.getMonth() === now.getMonth() && expDate.getFullYear() === now.getFullYear();
            });
            const actualTotal = monthExpenses.reduce((sum, e) => sum + parseFloat(e.montant || 0), 0);
            
            document.getElementById('budget-total').textContent = monthlyBudget.toFixed(2) + ' ' + settings.currency_symbol;
            document.getElementById('budget-actual').textContent = actualTotal.toFixed(2) + ' ' + settings.currency_symbol;
            
            const percent = monthlyBudget > 0 ? (actualTotal / monthlyBudget * 100) : 0;
            const progressBar = document.getElementById('budget-progress-bar');
            progressBar.style.width = Math.min(percent, 100) + '%';
            
            if (percent > 100) {
                progressBar.style.background = 'var(--danger)';
                document.getElementById('budget-status').textContent = `D√©passement de ${(percent - 100).toFixed(0)}%`;
            } else if (percent > 80) {
                progressBar.style.background = 'var(--warning)';
                document.getElementById('budget-status').textContent = `${percent.toFixed(0)}% du budget utilis√©`;
            } else {
                progressBar.style.background = 'var(--success)';
                document.getElementById('budget-status').textContent = `${percent.toFixed(0)}% du budget utilis√©`;
            }
        }
        
        // Liste r√©currentes
        function updateRecurrentList() {
            const container = document.getElementById('recurrent-list');
            
            if (recurrentExpenses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üîÑ</div>
                        <div class="empty-state-text">Aucune d√©pense r√©currente</div>
                    </div>
                `;
                return;
            }
            
            const frequencyLabels = {
                'daily': 'Quotidien',
                'weekly': 'Hebdomadaire',
                'monthly': 'Mensuel',
                'yearly': 'Annuel'
            };
            
            container.innerHTML = recurrentExpenses.map(rec => {
                const isActive = rec.active !== false;
                
                return `
                    <div class="recurrent-item">
                        <div class="recurrent-header">
                            <div class="recurrent-title">${rec.description}</div>
                            <div class="recurrent-amount">${parseFloat(rec.montant).toFixed(2)} ${settings.currency_symbol}</div>
                        </div>
                        <div class="recurrent-meta">
                            <span>üîÑ ${frequencyLabels[rec.frequency] || rec.frequency}</span>
                            <span>‚Ä¢</span>
                            <span>${rec.categorie || 'Autre'}</span>
                            <span>‚Ä¢</span>
                            <span>${rec.payeur || 'Non sp√©cifi√©'}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: var(--space-s);">
                            <span class="recurrent-badge ${isActive ? 'badge-active' : 'badge-inactive'}">
                                ${isActive ? '‚úì Active' : '‚è∏ Inactive'}
                            </span>
                        </div>
                        <div class="recurrent-actions">
                            <button class="btn btn-secondary btn-small" onclick="toggleRecurrent('${rec.id}')">
                                ${isActive ? '‚è∏ D√©sactiver' : '‚ñ∂ Activer'}
                            </button>
                            <button class="btn btn-secondary btn-small" onclick="deleteRecurrent('${rec.id}')">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Liste pr√©visionnelles
        function updatePrevisionnelList() {
            const container = document.getElementById('previsionnel-list');
            const previsionnels = budgetItems.filter(b => b.type === 'previsionnel');
            
            if (previsionnels.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <div class="empty-state-text">Aucune d√©pense pr√©visionnelle</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = previsionnels.map(prev => {
                const date = new Date(prev.date);
                const dateStr = date.toLocaleDateString('fr-FR', { day: 'numeric', month: 'long' });
                
                return `
                    <div class="recurrent-item">
                        <div class="recurrent-header">
                            <div class="recurrent-title">${prev.description}</div>
                            <div class="recurrent-amount">${parseFloat(prev.montant).toFixed(2)} ${settings.currency_symbol}</div>
                        </div>
                        <div class="recurrent-meta">
                            <span>üìÖ ${dateStr}</span>
                            <span>‚Ä¢</span>
                            <span>${prev.categorie || 'Autre'}</span>
                            <span>‚Ä¢</span>
                            <span>${prev.payeur || 'Non sp√©cifi√©'}</span>
                        </div>
                        <div class="recurrent-actions">
                            <button class="btn btn-secondary btn-small" onclick="deleteBudgetItem('${prev.id}')">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Liste objectifs
        function updateObjectifsList() {
            const container = document.getElementById('objectifs-list');
            const objectifs = budgetItems.filter(b => b.type === 'objectif');
            
            if (objectifs.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üíº</div>
                        <div class="empty-state-text">Aucun objectif d√©fini</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = objectifs.map(obj => {
                return `
                    <div class="recurrent-item">
                        <div class="recurrent-header">
                            <div class="recurrent-title">${obj.description}</div>
                            <div class="recurrent-amount">${parseFloat(obj.montant).toFixed(2)} ${settings.currency_symbol}/mois</div>
                        </div>
                        <div class="recurrent-meta">
                            <span>${obj.categorie || '√âpargne'}</span>
                        </div>
                        <div class="recurrent-actions">
                            <button class="btn btn-secondary btn-small" onclick="deleteBudgetItem('${obj.id}')">
                                üóëÔ∏è Supprimer
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Bottom sheets
        function showAddRecurrentSheet() {
            document.getElementById('add-recurrent-overlay').classList.add('active');
            document.getElementById('add-recurrent-sheet').classList.add('active');
            document.body.style.overflow = 'hidden';
            updateRecurrentFields();
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('recurrent-start-date').value = today;
        }
        
        function closeAddRecurrentSheet() {
            document.getElementById('add-recurrent-overlay').classList.remove('active');
            document.getElementById('add-recurrent-sheet').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function showAddPrevisionnelSheet() {
            document.getElementById('add-previsionnel-overlay').classList.add('active');
            document.getElementById('add-previsionnel-sheet').classList.add('active');
            document.body.style.overflow = 'hidden';
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('previsionnel-date').value = today;
        }
        
        function closeAddPrevisionnelSheet() {
            document.getElementById('add-previsionnel-overlay').classList.remove('active');
            document.getElementById('add-previsionnel-sheet').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function showAddObjectifSheet() {
            document.getElementById('add-objectif-overlay').classList.add('active');
            document.getElementById('add-objectif-sheet').classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        
        function closeAddObjectifSheet() {
            document.getElementById('add-objectif-overlay').classList.remove('active');
            document.getElementById('add-objectif-sheet').classList.remove('active');
            document.body.style.overflow = '';
        }
        
        function updateRecurrentFields() {
            const frequency = document.getElementById('recurrent-frequency').value;
            const dayOfWeekGroup = document.getElementById('recurrent-day-of-week-group');
            const dayOfMonthGroup = document.getElementById('recurrent-day-of-month-group');
            
            dayOfWeekGroup.classList.add('hidden');
            dayOfMonthGroup.classList.add('hidden');
            
            if (frequency === 'weekly') {
                dayOfWeekGroup.classList.remove('hidden');
            } else if (frequency === 'monthly') {
                dayOfMonthGroup.classList.remove('hidden');
            }
        }
        
        // Ajouter r√©currente
        async function addRecurrent(event) {
            event.preventDefault();
            
            const frequency = document.getElementById('recurrent-frequency').value;
            const recurrent = {
                room_id: currentRoomId,
                description: document.getElementById('recurrent-description').value,
                montant: parseFloat(document.getElementById('recurrent-amount').value),
                frequency: frequency,
                categorie: document.getElementById('recurrent-category').value,
                payeur: document.getElementById('recurrent-payeur').value,
                start_date: document.getElementById('recurrent-start-date').value,
                active: document.getElementById('recurrent-active').checked,
                created_at: new Date().toISOString()
            };
            
            if (frequency === 'weekly') {
                recurrent.day_of_week = parseInt(document.getElementById('recurrent-day-of-week').value);
            } else if (frequency === 'monthly') {
                recurrent.day_of_month = parseInt(document.getElementById('recurrent-day-of-month').value);
            }
            
            if (supabase) {
                await supabase.from('recurrent_expenses').insert(recurrent);
            }
            
            document.getElementById('recurrent-form').reset();
            closeAddRecurrentSheet();
            await loadBudgetData();
        }
        
        // Ajouter pr√©visionnelle
        async function addPrevisionnel(event) {
            event.preventDefault();
            
            const previsionnel = {
                id: 'prev-' + Date.now(),
                type: 'previsionnel',
                description: document.getElementById('previsionnel-description').value,
                montant: parseFloat(document.getElementById('previsionnel-amount').value),
                date: document.getElementById('previsionnel-date').value,
                categorie: document.getElementById('previsionnel-category').value,
                payeur: document.getElementById('previsionnel-payeur').value,
                created_at: new Date().toISOString()
            };
            
            budgetItems.push(previsionnel);
            
            if (supabase) {
                await supabase
                    .from('rooms')
                    .update({ budget_items: budgetItems })
                    .eq('room_id', currentRoomId);
            }
            
            document.getElementById('previsionnel-form').reset();
            closeAddPrevisionnelSheet();
            await loadBudgetData();
        }
        
        // Ajouter objectif
        async function addObjectif(event) {
            event.preventDefault();
            
            const objectif = {
                id: 'obj-' + Date.now(),
                type: 'objectif',
                description: document.getElementById('objectif-description').value,
                montant: parseFloat(document.getElementById('objectif-amount').value),
                categorie: document.getElementById('objectif-category').value,
                created_at: new Date().toISOString()
            };
            
            budgetItems.push(objectif);
            
            if (supabase) {
                await supabase
                    .from('rooms')
                    .update({ budget_items: budgetItems })
                    .eq('room_id', currentRoomId);
            }
            
            document.getElementById('objectif-form').reset();
            closeAddObjectifSheet();
            await loadBudgetData();
        }
        
        // Toggle r√©currente
        async function toggleRecurrent(id) {
            const rec = recurrentExpenses.find(r => r.id === id);
            if (!rec) return;
            
            const newStatus = !rec.active;
            
            if (supabase) {
                await supabase
                    .from('recurrent_expenses')
                    .update({ active: newStatus })
                    .eq('id', id);
            }
            
            await loadBudgetData();
        }
        
        // Supprimer r√©currente
        async function deleteRecurrent(id) {
            if (!confirm('Supprimer cette d√©pense r√©currente ?')) return;
            
            if (supabase) {
                await supabase
                    .from('recurrent_expenses')
                    .delete()
                    .eq('id', id);
            }
            
            await loadBudgetData();
        }
        
        // Supprimer budget item
        async function deleteBudgetItem(id) {
            if (!confirm('Supprimer cet √©l√©ment ?')) return;
            
            budgetItems = budgetItems.filter(b => b.id !== id);
            
            if (supabase) {
                await supabase
                    .from('rooms')
                    .update({ budget_items: budgetItems })
                    .eq('room_id', currentRoomId);
            }
            
            await loadBudgetData();
        }
        
        // ==========================================
        // PARAM√àTRES
        // ==========================================
        
        // Charger les param√®tres
        async function loadSettings() {
            if (!supabase || !currentRoomId) return;
            
            const { data } = await supabase
                .from('rooms')
                .select('*')
                .eq('room_id', currentRoomId)
                .single();
            
            if (data) {
                settings = {
                    parent1_name: data.parent1_name || 'Parent 1',
                    parent2_name: data.parent2_name || 'Parent 2',
                    parent1_email: data.parent1_email || '',
                    parent2_email: data.parent2_email || '',
                    currency_symbol: data.currency_symbol || '‚Ç¨',
                    email_frequency: data.email_frequency || 'none',
                    email_time: data.email_time || '18:00'
                };
                
                updateSettingsUI();
            }
        }
        
        function updateSettingsUI() {
            document.getElementById('settings-room-code').textContent = currentRoomId;
            document.getElementById('settings-parent1-name').value = settings.parent1_name || '';
            document.getElementById('settings-parent1-email').value = settings.parent1_email || '';
            document.getElementById('settings-parent2-name').value = settings.parent2_name || '';
            document.getElementById('settings-parent2-email').value = settings.parent2_email || '';
            document.getElementById('settings-email-frequency').value = settings.email_frequency || 'none';
            document.getElementById('settings-email-time').value = settings.email_time || '18:00';
            
            // Mettre √† jour les selects de payeur
            updatePayeurSelects();
        }
        
        function updatePayeurSelects() {
            const selects = ['expense-payeur', 'recurrent-payeur', 'previsionnel-payeur'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = `
                        <option value="Parent 1">${settings.parent1_name || 'Parent 1'}</option>
                        <option value="Parent 2">${settings.parent2_name || 'Parent 2'}</option>
                    `;
                }
            });
        }
        
        async function saveSettings() {
            settings.parent1_name = document.getElementById('settings-parent1-name').value || 'Parent 1';
            settings.parent1_email = document.getElementById('settings-parent1-email').value;
            settings.parent2_name = document.getElementById('settings-parent2-name').value || 'Parent 2';
            settings.parent2_email = document.getElementById('settings-parent2-email').value;
            settings.email_frequency = document.getElementById('settings-email-frequency').value;
            settings.email_time = document.getElementById('settings-email-time').value;
            
            if (supabase) {
                await supabase
                    .from('rooms')
                    .upsert({
                        room_id: currentRoomId,
                        parent1_name: settings.parent1_name,
                        parent1_email: settings.parent1_email,
                        parent2_name: settings.parent2_name,
                        parent2_email: settings.parent2_email,
                        email_frequency: settings.email_frequency,
                        email_time: settings.email_time
                    }, { onConflict: 'room_id' });
            }
            
            // Mettre √† jour l'UI
            updatePayeurSelects();
            updateDashboard();
            
            showToast('‚úì Param√®tres enregistr√©s');
        }
        
        function copyRoomCode() {
            navigator.clipboard.writeText(currentRoomId).then(() => {
                showToast('üìã Code copi√© !');
            });
        }
        
        // Cat√©gories
        function addCategory() {
            const name = prompt('Nom de la nouvelle cat√©gorie :');
            if (!name) return;
            
            const icon = prompt('Emoji (optionnel) :', 'üì¶');
            
            // TODO: Sauvegarder dans settings
            showToast('‚úì Cat√©gorie ajout√©e');
        }
        
        // Export/Import
        async function exportData() {
            const data = {
                version: '2.0',
                exported_at: new Date().toISOString(),
                room_id: currentRoomId,
                expenses: expenses,
                recurrent_expenses: recurrentExpenses,
                budget_items: budgetItems,
                settings: settings
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `depenses-${currentRoomId}-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('üì• Donn√©es export√©es');
        }
        
        function importData() {
            document.getElementById('import-file-input').click();
        }
        
        async function handleImportFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                if (!confirm('Importer ces donn√©es ? Les donn√©es actuelles seront remplac√©es.')) {
                    return;
                }
                
                // Importer dans Supabase
                if (supabase && data.expenses) {
                    // Supprimer les anciennes
                    await supabase.from('expenses').delete().eq('room_id', currentRoomId);
                    
                    // Ins√©rer les nouvelles
                    const expensesToImport = data.expenses.map(e => ({
                        ...e,
                        room_id: currentRoomId,
                        id: undefined // Laisser Supabase g√©n√©rer les IDs
                    }));
                    await supabase.from('expenses').insert(expensesToImport);
                    
                    // Charger les donn√©es
                    await loadData();
                    
                    showToast('‚úì Donn√©es import√©es');
                }
            } catch (error) {
                console.error('Erreur import:', error);
                alert('Erreur lors de l\'import : ' + error.message);
            }
        }
        
        // Email de test
        async function sendTestEmail() {
            if (!settings.parent1_email && !settings.parent2_email) {
                alert('Veuillez d\'abord configurer au moins un email dans les profils');
                return;
            }
            
            showToast('üì® Envoi en cours...');
            
            // TODO: Appeler l'edge function
            setTimeout(() => {
                showToast('‚úì Email de test envoy√© (simulation)');
            }, 2000);
        }
        
        // Toast notification
        function showToast(message) {
            // Cr√©er le toast s'il n'existe pas
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText = `
                    position: fixed;
                    bottom: calc(80px + env(safe-area-inset-bottom));
                    left: 50%;
                    transform: translateX(-50%) translateY(100px);
                    background: rgba(0, 0, 0, 0.85);
                    color: white;
                    padding: 12px 24px;
                    border-radius: 24px;
                    font-size: 14px;
                    font-weight: 600;
                    z-index: 10000;
                    transition: transform 0.3s ease;
                    backdrop-filter: blur(10px);
                `;
                document.body.appendChild(toast);
            }
            
            toast.textContent = message;
            toast.style.transform = 'translateX(-50%) translateY(0)';
            
            setTimeout(() => {
                toast.style.transform = 'translateX(-50%) translateY(100px)';
            }, 2000);
        }
        
        // ==========================================
        // SYNCHRONISATION REAL-TIME
        // ==========================================
        
        let realtimeChannel = null;
        
        function setupRealtimeSync() {
            if (!supabase || !currentRoomId) return;
            
            // S'abonner aux changements
            realtimeChannel = supabase
                .channel(`room-${currentRoomId}`)
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'expenses',
                        filter: `room_id=eq.${currentRoomId}`
                    },
                    (payload) => {
                        console.log('üîÑ Changement d√©tect√©:', payload);
                        loadData();
                    }
                )
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'recurrent_expenses',
                        filter: `room_id=eq.${currentRoomId}`
                    },
                    (payload) => {
                        console.log('üîÑ R√©currente modifi√©e:', payload);
                        loadBudgetData();
                    }
                )
                .subscribe((status) => {
                    console.log('üì° Statut sync:', status);
                    updateSyncStatus(status === 'SUBSCRIBED');
                });
        }
        
        function updateSyncStatus(connected) {
            const statusDot = document.getElementById('status-dot');
            const statusText = document.getElementById('status-text');
            
            if (connected) {
                statusDot.classList.remove('offline');
                statusText.textContent = 'Connect√©';
            } else {
                statusDot.classList.add('offline');
                statusText.textContent = 'D√©connect√©';
            }
        }
        
        // ==========================================
        // MISE √Ä JOUR GLOBALE INITIALISATION
        // ==========================================
        
        // Mettre √† jour showMainApp pour charger les param√®tres
        const originalShowMainApp = showMainApp;
        async function showMainApp() {
            await originalShowMainApp();
            await loadSettings();
            setupRealtimeSync();
        }
    </script>
</body>
</html>
